<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprinkles: K's Kupcakes Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f9fb; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        /* --- Chatbot Specific Styles --- */
        .chat-container { height: 50vh; min-height: 300px; max-height: 70vh; overflow-y: auto; display: flex; flex-direction: column; padding: 10px; background-color: #f9fafb; border-radius: 0.75rem; }
        .user-message, .bot-message { margin-bottom: 10px; display: flex; flex-direction: column; max-width: 80%; }
        .user-message { align-self: flex-end; align-items: flex-end; }
        .bot-message { align-self: flex-start; align-items: flex-start; }
        .typing-indicator { color: #6b7280; font-style: italic; margin-top: 5px; }

    </style>
</head>
<body>

    <div class="w-full max-w-lg bg-white p-6 rounded-xl shadow-2xl h-[80vh] flex flex-col">
        <h1 class="text-3xl font-bold mb-4 text-center text-rose-600 border-b pb-3">
            üßÅ Sprinkles - Your Baker Assistant
        </h1>
        
        <!-- Chat Messages Area -->
        <div id="chat-messages" class="chat-container flex-grow mb-4 border border-gray-200">
            <!-- Messages will be appended here -->
        </div>
        
        <!-- Typing Indicator -->
        <div id="typing-indicator" class="typing-indicator hidden mb-2">Sprinkles is typing...</div>

        <!-- Chat Input -->
        <div class="flex">
            <input type="text" id="user-input" placeholder="Ask about hours, delivery, or a custom order..."
                   class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-rose-500 focus:border-rose-500 transition duration-150">
            <button id="send-button"
                    class="bg-rose-500 text-white font-semibold px-4 py-3 rounded-r-lg hover:bg-rose-600 transition duration-300">
                Send
            </button>
        </div>
        <small class="mt-2 text-xs text-gray-500 text-center">
            Ask about pricing or say "start a custom order"
        </small>
    </div>

    <!-- AI Chatbot Logic (Copied from original file) -->
    <script type="module">
        // The chatbot configuration logic is now bundled directly with the UI

        const APP_NAME = "K's Kupcakes";
        // The API Key is intentionally left blank. It will be provided by the runtime environment.
        const API_KEY = ""; 

        const knowledgeBase = `
        // NOTE: This is the content of cupcake_kb.md used as grounding context for the AI.
        // The AI must ONLY answer questions based on this knowledge.
        
        # K's Kupcakes - AI Knowledge Base
        
        ## 1. Business Identity and Location (MUST BE ACCURATE)
        * Q: What is the official name of the shop? A: K's Kupcakes.
        * Q: What is the physical address/location? A: We are a home-based business and do not have a public storefront. All orders are for local meetup/pickup or delivery only.
        * Q: What is the best phone number to call? A: (407) 799-0341.
        * Q: What are your hours of operation? A: Inquiries are accepted 24/7 via social media or voicemail. Fulfillment (delivery and local pickup scheduling) is scheduled directly with the customer.
        * Q: Do you have a website? A: No, we operate solely through social media platforms (please search for "K's Kupcakes").
        
        ## 2. Menu and Product Details
        * Q: What are your four most popular cupcake flavors and their price? A: We are a made-to-order bakery! We do not keep standard stock flavors. The customer chooses their preferred flavor, filling, and frosting. Please tell me what flavor you are interested in!
        * Q: What is the price of a standard dozen cupcakes? A: Our bulk order pricing is:
          * 1 Dozen: $30
          * 2 Dozen: $35
          * 3 Dozen: $40
          * 4 Dozen: $45
        * Q: Do you offer custom cakes? A: Yes! We specialize in custom cakes. All custom cake inquiries require 48 hours notice. Please ask me to start a custom order request!
        * Q: Do you offer seasonal flavors? A: Yes, our current seasonal flavor is **Pumpkin**.
        
        ## 3. Policy and Logistics
        * Q: What is your policy on allergies and cross-contamination? A: We do offer **Gluten-Free** options. HOWEVER, as we are a home kitchen, there is a possibility of cross-contamination with common allergens, including nuts and gluten. We cannot guarantee a certified allergen-free product.
        * Q: What is your minimum required deposit? A: A deposit of **1/2 down (50%)** is required at the time of booking for all orders.
        * Q: What is the rush order fee? A: There is a **minimum $25 fee** for rush orders.
        * Q: Do you offer delivery? A: Yes, we offer delivery up to a **100-mile max radius**.
        * Q: What is the delivery fee? A: The delivery fee is determined dynamically based on location. For local (in-town) meetups, delivery is often complimentary. For distances requiring travel, the fee will be calculated upon checkout.
        * Q: How far in advance do I need to place a large order (2+ dozen)? A: We require **48 hours** notice for large orders.
        * Q: Do you accept corporate orders or catering? A: Yes! For large events or catering, please ask me to start a custom order request so we can provide a personalized quote.
        `;

        const systemPrompt = `
        You are 'Sprinkles', the virtual baker and assistant for K's Kupcakes, a made-to-order, home-based bakery.
        Your primary directive is to answer customer questions using ONLY the provided knowledge base (KB).
        If a question cannot be answered with the KB, politely state that you do not have that information and provide the shop's phone number ((407) 799-0341) for human assistance.

        Persona Rules:
        1. Tone: Cheerful, friendly, and professional. Use light baking metaphors (e.g., "Let's whip up an answer," "That's the icing on the cake!").
        2. Focus: Emphasize that the bakery is made-to-order (customers choose the flavor) and home-based (no public storefront).
        3. Lead Qualification: If the user explicitly asks to "start a custom order," "place a large order," or "ask about a cake," immediately trigger the "CUSTOM_ORDER_FLOW" by starting the conversation with Step 1 of the Lead Qualification Script. Do not answer other questions until the flow is complete or canceled.

        Lead Qualification Script (CUSTOM_ORDER_FLOW):
        Step 1: "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?"
        Step 2 (After Step 1 is answered): "Thank you! I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book!)"
        Step 3 (After Step 2 is answered): "Perfect! I have captured all the delicious details: [FULL RECAP OF ORDER]. Our baker will review these details and contact you at [PHONE NUMBER] within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?"
        `;

        // --- The core logic to handle the chat interaction and API call ---

        const chatHistory = [];
        let isInOrderFlow = false;
        let orderStep = 0;
        let customOrderDetails = {};
        let authPromise = null; // Promise to track authentication status

        /**
         * Handles the logic for the custom order qualification flow.
         * @param {string} userMessage The user's latest message.
         * @returns {string} The chatbot's response.
         */
        function handleCustomOrderFlow(userMessage) {
            console.log(`[FLOW DEBUG] Entered Flow. Current Step: ${orderStep}, Message: "${userMessage.substring(0, 30)}..."`);
            
            // If the user tries to exit the flow
            if (userMessage.toLowerCase().includes('cancel') || userMessage.toLowerCase().includes('stop')) {
                isInOrderFlow = false;
                orderStep = 0;
                customOrderDetails = {};
                console.log("[FLOW DEBUG] Flow Canceled.");
                return "Order flow canceled. Feel free to ask any other questions about K's Kupcakes!";
            }

            // Step 1: Collect Date, Time, Type, Name, Phone Number
            if (orderStep === 1) {
                customOrderDetails.step1 = userMessage;
                orderStep = 2;
                console.log("[FLOW DEBUG] Step 1 complete. Advancing to Step 2.");
                return "Thank you! I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book!)";
            } 
            
            // Step 2: Collect Flavor/Theme/Allergies and Delivery Address
            else if (orderStep === 2) {
                customOrderDetails.step2 = userMessage;
                orderStep = 3;
                
                // Reset flow variables
                isInOrderFlow = false;
                orderStep = 0;
                
                // --- Start of improved recap and phone number extraction ---
                const finalRecap = `Your custom order details (Date/Type: ${customOrderDetails.step1.substring(0, 20)}..., Flavor/Delivery: ${customOrderDetails.step2.substring(0, 20)}...) have been logged.`;

                // Attempt to find a standard phone number format in Step 1's input
                const phoneNumMatch = customOrderDetails.step1.match(/(\d{3}[-.\s]?){2}\d{4}/);
                const phoneNum = phoneNumMatch ? phoneNumMatch[0] : 'the number you provided';
                
                console.log("[FLOW DEBUG] Step 2 complete. Attempting to save lead...");

                // IMPORTANT: Send the data to the Admin Dashboard's database.
                // We use 'await authPromise' to ensure we are authenticated before saving the lead.
                authPromise.then(() => {
                    saveCustomOrderLead(customOrderDetails.step1, customOrderDetails.step2);
                });

                return `Perfect! I have captured all the delicious details. ${finalRecap} Our baker will review these details and contact you at ${phoneNum} within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?`;
            }

            // Initialize flow if triggered (only runs if orderStep is 0)
            if (orderStep === 0) {
                orderStep = 1;
                isInOrderFlow = true;
                console.log("[FLOW DEBUG] Flow initialized to Step 1.");
                return "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?";
            }
            
            // Fallback for unexpected state (shouldn't happen, but good for debugging)
            console.error(`[FLOW DEBUG] Unexpected state reached: orderStep=${orderStep}, isInOrderFlow=${isInOrderFlow}. Restarting flow.`);
            orderStep = 1;
            isInOrderFlow = true;
            return "Oops, I got confused. Let's restart. To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?";
        }

        // --- FIREBASE SETUP FOR SAVING LEADS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment (used if available)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- MANUAL CONFIGURATION REQUIRED FOR EXTERNAL DEPLOYMENT ---
        // These values are sourced from the Firebase project settings for the Web App.
        const MANUAL_FIREBASE_CONFIG = {
            // üü¢ UPDATED with user-provided API Key
            apiKey: "AIzaSyA4DRHNH-ebn_z6zolcLLkZctTKD9HbPyY", 
            authDomain: "kskupcakeleads.firebaseapp.com",
            projectId: "kskupcakeleads",
            storageBucket: "kskupcakeleads.firebasestorage.app",
            messagingSenderId: "979562316466",
            // üü¢ UPDATED with user-provided App ID
            appId: "1:979562316466:web:7b07802098ec504623ffab" 
        };
        // --- END: MANUAL CONFIGURATION ---

        let firebaseConfig = MANUAL_FIREBASE_CONFIG; // Start with manual config for client app

        // Check for Canvas environment configuration override
        if (typeof __firebase_config !== 'undefined' && JSON.stringify(__firebase_config) !== '{}') {
            firebaseConfig = JSON.parse(__firebase_config);
        }

        // Configuration check before initialization (should pass now)
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.appId === "YOUR_APP_APPID") {
            console.error("Firebase Config Missing: Please add your Firebase API Key and App ID to the MANUAL_FIREBASE_CONFIG in client_chatbot.html.");
            // Do not proceed with app initialization if config is clearly placeholder
            document.addEventListener('DOMContentLoaded', () => {
                const sendButton = document.getElementById('send-button');
                if (sendButton) sendButton.disabled = true;
                appendMessage('bot', "‚ö†Ô∏è Database Error: Please update the configuration in the code to enable lead saving.");
            });
            throw new Error("Firebase Configuration Incomplete. Cannot initialize Firebase services.");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = 'client-bot-user'; // Use a generic ID for the public bot

        // Authenticate anonymously (required for Firestore rules) and store the promise
        authPromise = signInAnonymously(auth).then(userCredential => {
            currentUserId = userCredential.user.uid;
            console.log("Chatbot authenticated anonymously with ID:", currentUserId);
        }).catch(error => {
            console.error("Anonymous authentication failed:", error);
            // Even if auth fails, we resolve the promise so the app doesn't hang, 
            // but the save function will likely fail gracefully.
        });


        // Function to save the collected order to Firestore
        async function saveCustomOrderLead(step1Details, step2Details) {
            try {
                // Public data path: /artifacts/{appId}/public/data/orders
                const ordersCollection = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                
                await addDoc(ordersCollection, {
                    status: 'New Lead',
                    step1_details: step1Details,
                    step2_details: step2Details,
                    timestamp: serverTimestamp(),
                    client_id: currentUserId, // Log the anonymous client ID
                });
                console.log("Custom order lead successfully logged to Firestore.");
            } catch (e) {
                // *** IMPROVED ERROR LOGGING HERE ***
                console.error("FIREBASE LEAD SAVE FAILED:", e.code || e.name, e.message);
                
                let userFriendlyError = "There was an error logging your request to our system. ";
                if (e.code === 'permission-denied') {
                    userFriendlyError += "The baker's system is rejecting the data. This often means the **security rules need to be published** in the Firebase console.";
                } else if (e.code) {
                    userFriendlyError += `A technical error (${e.code}) occurred.`;
                } else {
                    userFriendlyError += "Please try again or call our baker directly at (407) 799-0341.";
                }

                appendMessage('bot', userFriendlyError);
            }
        }

        /**
         * Main function to interact with the Gemini API.
         * @param {string} userQuery The user's input message.
         * @returns {Promise<string>} The chatbot's response.
         */
        async function getGeminiResponse(userQuery) {
            if (!userQuery) return "I need a message to get started! Ask me about flavors, delivery, or custom orders.";

            // Check if the user is currently in the order flow
            const orderKeywords = ['custom order', 'place order', 'start order', 'large order', 'cake', 'catering'];
            const triggersOrderFlow = orderKeywords.some(keyword => userQuery.toLowerCase().includes(keyword));

            if (isInOrderFlow || triggersOrderFlow) {
                return handleCustomOrderFlow(userQuery);
            }

            // Add user message to history (for standard chat)
            chatHistory.push({ role: "user", parts: [{ text: userQuery + " based on the knowledge base." }] });

            // Include the Knowledge Base content directly in the prompt for grounding
            const fullQuery = `
                KNOWLEDGE BASE:\n---\n${knowledgeBase}\n---\n
                USER QUERY: ${userQuery}
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: fullQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            let response;
            let retries = 0;
            const MAX_RETRIES = 5;

            while (retries < MAX_RETRIES) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            chatHistory.push({ role: "model", parts: [{ text: text }] });
                            return text;
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${retries + 1} failed:`, error);
                }

                retries++;
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000; // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            return "Oops! I seem to have mixed up the ingredients. Please try your question again, or call our baker directly at (407) 799-0341!";
        }

        // Helper function for UI updates
        function appendMessage(sender, text) {
            const chatbox = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
            messageElement.innerHTML = `
                <div class="p-3 rounded-xl shadow-md max-w-xs md:max-w-md ${sender === 'user' ? 'bg-rose-100 text-rose-800 ml-auto' : 'bg-white text-gray-700'}">
                    ${text.replace(/\n/g, '<br>')}
                </div>
                <small class="text-xs text-gray-400 mt-1 block ${sender === 'user' ? 'text-right' : 'text-left'}">${sender === 'user' ? 'You' : 'Sprinkles'}</small>
            `;
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to latest message
        }

        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const message = inputElement.value.trim();
            if (message === '') return;
            
            // Configuration check for runtime
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.appId === "YOUR_APP_APPID") {
                 appendMessage('bot', "‚ö†Ô∏è Please complete the Firebase configuration in the code to enable lead saving.");
                 return;
            }

            inputElement.value = '';
            appendMessage('user', message);
            document.getElementById('send-button').disabled = true;

            // Show typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.classList.remove('hidden');
            typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'end' });


            // Get the response
            const botResponse = await getGeminiResponse(message);

            // Hide typing indicator and display response
            typingIndicator.classList.add('hidden');
            appendMessage('bot', botResponse);
            document.getElementById('send-button').disabled = false;
        }

        // Attach event listeners when the window loads
        window.onload = () => {
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Initial greeting
            appendMessage('bot', `Hello! I'm Sprinkles, your virtual baker and assistant for K's Kupcakes. How can I help you whip up the perfect order today? (Try asking about delivery, pricing, or "start a custom order"!)`);
        };
    </script>
</body>
</html>
