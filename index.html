<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K's Kupcakes Chatbot</title>
    <!-- 
        NOTE ON SECURITY & PERFORMANCE FEEDBACK:
        Most issues reported (Content-Type, Cache-Control, X-Content-Type-Options, 
        X-XSS-Protection, X-Runtime, X-Frame-Options) are server-side configurations. 
        These cannot be modified from within this HTML file.
    -->
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0; /* Soft, creamy background */
            /* Addressing Compatibility Warning */
            text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%; /* Added for better cross-browser compatibility */
        }
        .chat-container {
            height: 85vh; /* Responsive height */
            max-width: 900px;
        }
        .chat-messages {
            height: calc(100% - 100px); /* Adjust based on input size */
            overflow-y: auto;
            padding: 1rem;
            background-color: #fff8f5; /* Lighter background for messages */
            border-radius: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .user-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .bot-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #f687b3; /* Pink dot */
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 0.6s infinite alternate;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        .error-message {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #fca5a5;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div class="chat-container w-full bg-white rounded-3xl shadow-xl flex flex-col overflow-hidden border-4 border-pink-300">
        
        <!-- Header -->
        <header class="p-4 bg-pink-500 text-white shadow-lg flex items-center justify-between">
            <h1 class="text-2xl font-extrabold tracking-tight">üßÅ K's Kupcakes üßÅ</h1>
            <span class="text-sm font-light">Chat with Sprinkles (AI Assistant)</span>
        </header>

        <!-- Messages Area -->
        <div id="chat-messages" class="chat-messages flex-grow">
            <!-- Messages will be appended here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden p-3 ml-4">
            <div class="flex items-center space-x-1 p-2 bg-gray-100 rounded-lg max-w-min shadow-sm">
                <span class="text-xs text-gray-500">Sprinkles is typing</span>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <!-- Input Area - Structured with <form> for robustness -->
        <footer class="p-4 border-t border-gray-200 bg-white">
            <form id="chat-form" class="flex space-x-3">
                <input 
                    type="text" 
                    id="user-input" 
                    name="message" 
                    aria-label="Chat message input field" 
                    placeholder="Type your message here..."
                    class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-pink-400 focus:border-pink-400 transition duration-150" 
                    autocomplete="off"
                />
                
                <button 
                    id="send-button" 
                    type="submit" 
                    aria-label="Send message" 
                    class="bg-pink-500 text-white p-3 rounded-full hover:bg-pink-600 transition duration-150 shadow-md flex items-center justify-center disabled:bg-pink-300"
                >
                    <svg xmlns="http://www.w3.org/2d00/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </form>
            <!-- Status message element -->
            <div id="status-message" class="text-xs mt-2 text-center text-gray-500 transition-colors duration-300">Loading Sprinkles...</div>
        </footer>
    </div>

    <!-- The Chatbot Logic Script -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables & Initialization ---
        let db;
        let auth;
        let userId = 'anonymous';
        let isAuthReady = false;
        
        // Use provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // FIXED: Added fallback projectId to prevent "projectId not provided" error
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        setLogLevel('debug'); // Enable detailed Firebase logs

        // --- UI Functions (Defined early to be used immediately) ---
        function appendMessage(sender, text) {
            const chatbox = document.getElementById('chat-messages');
            if (!chatbox) {
                 console.error("Chatbox element not found!");
                 return; // Guard clause if DOM isn't fully ready yet
            }

            const messageElement = document.createElement('div');
            messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
            // Use innerHTML to allow the error-message div to render
            messageElement.innerHTML = `
                <div class="${text.includes('FATAL API ERROR') || text.includes('CRITICAL ERROR') || text.includes('Database Error') ? 'error-message max-w-lg' : 'p-3 rounded-xl shadow-md max-w-xs md:max-w-md bg-white text-gray-700'} ${sender === 'user' ? 'bg-indigo-100 text-indigo-800 ml-auto' : ''}">
                    ${text.replace(/\n/g, '<br>')}
                </div>
                <small class="text-xs text-gray-400 mt-1 block ${sender === 'user' ? 'text-right' : 'text-left'}">${sender === 'user' ? 'You' : 'Sprinkles'}</small>
            `;
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight;
        }


        // 1. Initialize Firebase App
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
             console.error("Firebase Initialization Failed:", e);
             const statusElement = document.getElementById('status-message');
             if (statusElement) {
                statusElement.textContent = `Database connection FAILED: ${e.message}. Orders cannot be saved.`;
                statusElement.classList.remove('text-gray-500', 'text-green-600');
                statusElement.classList.add('text-red-600');
             }
        }


        /**
         * Determines the Firestore collection path for saving private order data.
         * Data path: /artifacts/{appId}/users/{userId}/orders
         * @returns {string} The path string.
         */
        function getPrivateOrderCollectionPath() {
            return `artifacts/${appId}/users/${userId}/orders`;
        }

        // 2. Handle Authentication
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                const statusElement = document.getElementById('status-message');
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    
                    // Update status visual on success
                    if (statusElement && !statusElement.classList.contains('text-red-600')) {
                        statusElement.textContent = `Database connected. User: ${userId.substring(0, 8)}...`;
                        statusElement.classList.remove('text-gray-500');
                        statusElement.classList.add('text-green-600');
                    }
                } else {
                    // If not signed in via token, sign in anonymously
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous Sign-in failed:", error);
                        // Update status visual on failure
                        if (statusElement) {
                            statusElement.textContent = 'Database connection failed. Order saving disabled.';
                            statusElement.classList.remove('text-gray-500', 'text-green-600');
                            statusElement.classList.add('text-red-600');
                        }
                    }
                }
            });

            // Use the initial auth token if provided (Canvas environment)
            if (typeof __initial_auth_token !== 'undefined') {
                signInWithCustomToken(auth, __initial_auth_token).catch(error => {
                    console.error("Custom token sign-in failed, trying anonymous:", error);
                    signInAnonymously(auth);
                });
            } else {
                signInAnonymously(auth);
            }
        }


        // --- Chatbot Configuration ---
        const API_KEY = "AIzaSyDqZi2PHfuNciyv8Rsj8budM2I8t5HhC9g"; 
        // Updated model name to latest preview for text generation
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // ... [knowledgeBase and systemPrompt remain the same] ...
        const knowledgeBase = `
        // K's Kupcakes Knowledge Base (This is the grounding data for the AI)
        
        ## 1. Business Identity and Location (MUST BE ACCURATE)
        * Q: What is the official name of the shop? A: K's Kupcakes.
        * Q: What is the physical address/location? A: We are a home-based business and do not have a public storefront. All orders are for local meetup/pickup or delivery only.
        * Q: What is the best phone number to call? A: (407) 799-0341.
        * Q: What are your hours of operation? A: Inquiries are accepted 24/7 via social media or voicemail. Fulfillment (delivery and local pickup scheduling) is scheduled directly with the customer.
        * Q: Do you have a website? A: No, we operate solely through social media platforms (please search for "K's Kupcakes").
        
        ## 2. Menu and Product Details
        * Q: What are your four most popular cupcake flavors and their price? A: We are a made-to-order bakery! We do not keep standard stock flavors. The customer chooses their preferred flavor, filling, and frosting. Please tell me what flavor you are interested in!
        * Q: What is the price of a standard dozen cupcakes? A: Our bulk order pricing is:
            * 1 Dozen: $30
            * 2 Dozen: $35
            * 3 Dozen: $40
            * 4 Dozen: $45
        * Q: Do you offer custom cakes? A: Yes! We specialize in custom cakes. All custom cake inquiries require 48 hours notice. Please ask me to start a custom order request!
        * Q: Do you offer seasonal flavors? A: Yes, our current seasonal flavor is Pumpkin.
        
        ## 3. Policy and Logistics
        * Q: What is your minimum required deposit? A: A deposit of 1/2 down (50%) is required at the time of booking for all orders.
        * Q: What is the rush order fee? A: There is a minimum $25 fee for rush orders.
        * Q: Do you offer delivery? A: Yes, we offer delivery up to a 100-mile max radius.
        * Q: What is the delivery fee? A: The delivery fee is determined dynamically based on location. For local (in-town) meetups, delivery is often complimentary. For distances requiring travel, the fee will be calculated upon checkout.
        * Q: How far in advance do I need to place a large order (2+ dozen)? A: We require 48 hours notice for large orders.
        * Q: Do you accept corporate orders or catering? A: Yes! For large events or catering, please ask me to start a custom order request so we can provide a personalized quote.
        `;

        const systemPrompt = `
        You are 'Sprinkles', the virtual baker and assistant for K's Kupcakes, a made-to-order, home-based bakery.
        Your primary directive is to answer customer questions using ONLY the provided knowledge base (KB).
        If a question cannot be answered with the KB, politely state that you do not have that information and provide the shop's phone number ((407) 799-0341) for human assistance.

        Persona Rules:
        1. Tone: Cheerful, friendly, and professional. Use light baking metaphors (e.g., "Let's whip up an answer," "That's the icing on the cake!").
        2. Focus: Emphasize that the bakery is made-to-order (customers choose the flavor) and home-based (no public storefront).
        3. Lead Qualification: If the user explicitly asks to "start a custom order," "place a large order," or "ask about a cake," immediately trigger the "CUSTOM_ORDER_FLOW" by starting the conversation with Step 1 of the Lead Qualification Script. Do not answer other questions until the flow is complete or canceled.

        Lead Qualification Script (CUSTOM_ORDER_FLOW):
        Step 1: "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?"
        Step 2 (After Step 1 is answered): "Thank Muffin! I see you need [RECAP DETAILS]. I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book!)"
        Step 3 (After Step 2 is answered): "Perfect! I have captured all the delicious details: [FULL RECAP OF ORDER]. Our baker will review these details and contact you at [PHONE NUMBER] within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?"
        `;
        // --- Core Logic (API & Flow Handling) ---

        let isInOrderFlow = false;
        let orderStep = 0;
        let customOrderDetails = {};

        async function handleCustomOrderFlow(userMessage) {
            if (userMessage.toLowerCase().includes('cancel') || userMessage.toLowerCase().includes('stop')) {
                isInOrderFlow = false;
                orderStep = 0;
                customOrderDetails = {};
                return "Order flow canceled. Feel free to ask any other questions about K's Kupcakes!";
            }

            if (orderStep === 1) {
                // Process the answer to Step 1 (Date, Item, Contact)
                customOrderDetails.contact_info = userMessage;
                orderStep = 2;
                const recap = userMessage.length > 50 ? userMessage.substring(0, 50) + '...' : userMessage;
                // ADDED explicit cancel instruction
                return `Thank Muffin! I see you need: "${recap}". I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book! Type 'cancel' to exit this flow.)`;
            } else if (orderStep === 2) {
                // Process the answer to Step 2 (Details, Location)
                customOrderDetails.details_and_location = userMessage;
                orderStep = 3;
                
                // FINAL STEP: Save to Firestore
                if (isAuthReady && db) { // Check if Firestore is initialized
                    try {
                        const newOrder = {
                            date_created: new Date().toISOString(),
                            user_id: userId,
                            step1: customOrderDetails.contact_info,
                            step2: customOrderDetails.details_and_location,
                            status: "New Lead",
                        };
                        
                        await addDoc(collection(db, getPrivateOrderCollectionPath()), newOrder);
                        console.log("Order saved to Firestore successfully:", newOrder);
                    } catch (e) {
                        console.error("Error saving order to Firestore:", e);
                        // Changed message to reflect the attempt to save
                        return `<div class="error-message">Database Error: Order was captured, but failed to save to our system. Please call (407) 799-0341 to ensure your order is placed.</div>`;
                    }
                } else {
                    console.warn("Firestore not ready or initialized. Order will not be saved persistently.");
                }

                const phoneNumMatch = customOrderDetails.contact_info.match(/\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/);
                const phoneNum = phoneNumMatch ? phoneNumMatch[0] : '(407) 799-0341';
                const recap = `Contact: ${customOrderDetails.contact_info.substring(0, 30)}... | Details: ${customOrderDetails.details_and_location.substring(0, 30)}...`;

                isInOrderFlow = false;
                orderStep = 0;
                customOrderDetails = {};
                return `Perfect! I have captured all the delicious details: ${recap}. Our baker will review these details and contact you at ${phoneNum} within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?`;
            }

            // Only enter this block if the flow is triggered AND orderStep is 0 (initial start)
            if (orderStep === 0) {
                orderStep = 1;
                isInOrderFlow = true;
                // Returns Step 1 prompt
                return "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back? (Type 'cancel' to exit this flow.)";
            }
        }

        async function getGeminiResponse(userQuery) {
            if (!userQuery) return "I need a message to get started! Ask me about flavors, delivery, or custom orders.";
            
            // Convert to lowercase once for efficiency
            const userMessageLower = userQuery.toLowerCase();

            // Define trigger phrases for the custom order flow
            const flowTriggers = ['custom order', 'place order', 'start order', 'yes', 'i do', 'i want to', 'i want', 'cake'];

            // Check if the message contains a trigger
            const isTriggeringFlow = flowTriggers.some(trigger => userMessageLower.includes(trigger));

            // FIXED BUG: Prioritize existing flow progression over re-triggering the start.
            if (isInOrderFlow) {
                 return await handleCustomOrderFlow(userQuery);
            }
            
            // Only initiate flow if not already in flow AND message contains a trigger
            if (isTriggeringFlow) {
                // Sets orderStep=1 and isInOrderFlow=true and returns Step 1 prompt
                return await handleCustomOrderFlow(userQuery); 
            }
            
            // Fallback to Gemini API for general questions
            const fullQuery = `
                KNOWLEDGE BASE:\n---\n${knowledgeBase}\n---\n
                USER QUERY: ${userQuery}
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: fullQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `${API_URL_BASE}?key=${API_KEY}`;

            let response;
            let retries = 0;
            const MAX_RETRIES = 5;

            while (retries < MAX_RETRIES) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const status = response.status;
                        const errorBody = await response.text();
                        console.error(`API Error Status: ${status}. Body: ${errorBody}`);

                        if (status === 400 || status === 403) {
                            return `<div class="error-message">
                                    FATAL API ERROR (Code ${status}): Sprinkles can't talk! This means the key is likely invalid or restricted. Please double-check your API Key in the Google AI Studio settings.
                                    </div>`;
                        }
                    }

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${retries + 1} failed with network error:`, error);
                }

                retries++;
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            return "Oops! I seem to have mixed up the ingredients. Please try your question again, or call our baker directly at (407) 799-0341!";
        }

        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const message = inputElement.value.trim();
            if (message === '') return;

            console.log("sendMessage called with message:", message); // Debug log

            inputElement.value = '';
            appendMessage('user', message);
            document.getElementById('send-button').disabled = true;

            const typingIndicator = document.getElementById('typing-indicator');
            typingIndicator.classList.remove('hidden');
            typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'end' });

            const botResponse = await getGeminiResponse(message);

            typingIndicator.classList.add('hidden');
            appendMessage('bot', botResponse);
            document.getElementById('send-button').disabled = false;
        }

        // --- Event Listeners (DOM Ready) ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM Content Loaded. Initializing chat.");

            // Display initial greeting here to ensure DOM readiness
            appendMessage('bot', `Hello! I'm Sprinkles, your virtual baker and assistant for K's Kupcakes. How can I help you whip up the perfect order today? (Try asking about delivery, pricing, or "start a custom order"!)`);
            
            // This handles both button click and pressing 'Enter' key
            const chatForm = document.getElementById('chat-form');
            if (chatForm) {
                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault(); // Stop form from causing a page refresh
                    sendMessage();
                });
            }
        });
    </script>
</body>
</html>
