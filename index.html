<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Order Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* Custom scrollbar for better visibility */
        .order-list-container::-webkit-scrollbar { width: 8px; }
        .order-list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .order-list-container::-webkit-scrollbar-track { background: #f1f5f9; }

        /* --- Chatbot Specific Styles --- */
        .chat-container { height: 400px; overflow-y: auto; display: flex; flex-direction: column; padding: 10px; background-color: #f9fafb; border-radius: 0.75rem; }
        .user-message, .bot-message { margin-bottom: 10px; display: flex; flex-direction: column; max-width: 80%; }
        .user-message { align-self: flex-end; align-items: flex-end; }
        .bot-message { align-self: flex-start; align-items: flex-start; }
        .typing-indicator { color: #6b7280; font-style: italic; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- Auth Status & User Info -->
        <div id="auth-info" class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-4 rounded-lg shadow-md border-b-4 border-indigo-500">
            <h1 class="text-3xl font-bold text-gray-800">Order Management & Chat</h1>
            <p id="user-display" class="text-sm text-gray-600 mt-2 sm:mt-0 truncate max-w-full sm:max-w-[200px]"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- 1. Orders List (Dashboard) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Live Orders Dashboard</h2>
                <!-- THIS IS THE ELEMENT THAT DISPLAYS ORDERS -->
                <div id="orders-container" class="order-list-container space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-8" id="loading-message">Loading orders...</p>
                </div>
            </div>

            <!-- 2. Chatbot (Client-Facing Tool) -->
            <div class="lg:col-span-1 flex flex-col bg-white p-6 rounded-xl shadow-2xl h-[80vh]">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Sprinkles Chatbot Test</h2>
                
                <!-- Chat Messages Area -->
                <div id="chat-messages" class="chat-container flex-grow mb-4 border border-gray-200">
                    <!-- Messages will be appended here -->
                </div>
                
                <!-- Typing Indicator -->
                <div id="typing-indicator" class="typing-indicator hidden mb-2">Sprinkles is typing...</div>

                <!-- Chat Input -->
                <div class="flex">
                    <input type="text" id="user-input" placeholder="Ask about hours, delivery, or a custom order..."
                           class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                    <button id="send-button"
                            class="bg-indigo-600 text-white font-semibold px-4 py-3 rounded-r-lg hover:bg-indigo-700 transition duration-300">
                        Send
                    </button>
                </div>
                <small class="mt-2 text-xs text-gray-500 text-center">
                    (This is the user-facing app and the administrative dashboard combined into one file.)
                </small>
            </div>

        </div>
    </div>

    <!-- Custom Modal UI for deletion confirmation is injected dynamically -->

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            doc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            setLogLevel,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIG & INITIALIZATION ---

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // Canvas provides this at runtime.

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        setLogLevel('debug');

        let currentUserId = null;
        let isAuthReady = false;

        // --- DOM Elements ---
        const ordersContainer = document.getElementById('orders-container');
        const userDisplay = document.getElementById('user-display');
        const loadingMessage = document.getElementById('loading-message');


        // --- 1. FIRESTORE AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userDisplay.textContent = `Admin User ID: ${currentUserId}`;
                console.log("Authentication successful. User ID:", currentUserId);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                }
            }
            
            isAuthReady = true;
            
            // Start the Firestore listener for the Dashboard
            if (currentUserId) {
                setupOrderListener();
            } else {
                // If sign-in failed, still mark ready, but the listener won't start
                console.warn("User ID not available. Dashboard features may be limited.");
            }
        });


        // --- 2. DASHBOARD LOGIC (Order Management) ---

        /**
         * Sets up the real-time listener for the admin's private order collection.
         */
        function setupOrderListener() {
            // Path structure: /artifacts/{appId}/users/{userId}/orders
            const ordersCollectionPath = `artifacts/${appId}/users/${currentUserId}/orders`;
            const ordersRef = collection(db, ordersCollectionPath);
            
            onSnapshot(query(ordersRef), (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                console.log("Fetched orders:", orders);
                renderOrders(orders);
            }, (error) => {
                console.error("Error listening to orders (Check Security Rules):", error);
                if (ordersContainer) {
                    ordersContainer.innerHTML = '<p class="text-red-500 text-center py-8">Error loading data. Check console for details (Permissions issue).</p>';
                }
            });
        }

        /**
         * Dynamically generates the HTML for the order list.
         */
        function renderOrders(orders) {
            if (!ordersContainer) return;

            loadingMessage.classList.add('hidden'); 

            if (orders.length === 0) {
                ordersContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No orders found.</p>';
                return;
            }

            ordersContainer.innerHTML = ''; // Clear existing content
            orders.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis());

            orders.forEach(order => {
                const statusColor = getStatusColor(order.status);
                const orderCard = document.createElement('div');
                
                // Determine what content to show based on the data source
                let orderTitle = order.item || (order.details ? `Chat Lead: ${order.details.OrderType || 'Custom Order'}` : 'New Order');
                let orderSubtitle = order.quantity ? `(${order.quantity})` : (order.details?.Date ? `Date: ${order.details.Date}` : '');
                let orderContact = order.details?.ContactInfo || 'N/A';
                let orderDetailsHTML = order.details ? `
                    <div class="mt-2 text-sm text-gray-600 space-y-1 border-t pt-2 mt-2">
                        <p><strong>Contact:</strong> ${orderContact}</p>
                        <p><strong>Order Type:</strong> ${order.details.OrderType || 'Unknown'}</p>
                        <p><strong>Details:</strong> ${order.details.Details || 'No details provided'}</p>
                        <p><strong>Delivery:</strong> ${order.details.DeliveryAddress || 'Not specified'}</p>
                    </div>
                ` : '';

                orderCard.id = `order-${order.id}`;
                orderCard.className = 'bg-gray-50 p-4 rounded-lg shadow-md hover:shadow-lg transition duration-200 border-l-4 ' + statusColor.border;
                orderCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${orderTitle} ${orderSubtitle}</p>
                            <p class="text-xs text-gray-500 mt-0.5">Order ID: ${order.id}</p>
                            <p class="text-xs text-gray-500">
                                Placed: ${order.createdAt ? new Date(order.createdAt.toMillis()).toLocaleString() : 'N/A'}
                            </p>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-full ${statusColor.bg} ${statusColor.text}">
                            ${order.status}
                        </span>
                    </div>
                    ${orderDetailsHTML}
                    <div class="mt-3 flex space-x-2 border-t pt-3">
                        <select id="status-select-${order.id}" class="p-1 text-sm border border-gray-300 rounded-lg bg-white">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                        <button data-id="${order.id}" data-action="delete" class="text-red-500 hover:text-red-700 text-sm p-1 rounded transition duration-150">
                            Delete
                        </button>
                    </div>
                `;

                // Add event listeners for status change and delete
                const statusSelect = orderCard.querySelector(`#status-select-${order.id}`);
                statusSelect.addEventListener('change', (e) => updateOrderStatus(order.id, e.target.value));

                const deleteButton = orderCard.querySelector(`[data-action="delete"]`);
                deleteButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    showConfirmModal(`Are you sure you want to delete this order? This action cannot be undone.`, () => deleteOrder(order.id));
                });

                ordersContainer.appendChild(orderCard);
            });
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Pending': return { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-500' };
                case 'Processing': return { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-500' };
                case 'Confirmed': return { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500' };
                case 'Delivered': return { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-500' };
                default: return { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-500' };
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            if (!currentUserId) return;
            try {
                const orderDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/orders`, orderId);
                await updateDoc(orderDocRef, { status: newStatus });
                console.log("Order status updated to:", newStatus);
            } catch (error) {
                console.error("Error updating status:", error);
            }
        }

        async function deleteOrder(orderId) {
            if (!currentUserId) return;
            try {
                const orderDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/orders`, orderId);
                await deleteDoc(orderDocRef);
                console.log("Order successfully deleted:", orderId);
            } catch (error) {
                console.error("Error deleting order:", error);
            }
        }

        // --- Utility Functions (Modal) ---

        // Custom Modal UI (Replaces confirm() / alert())
        function showConfirmModal(message, onConfirm) {
            // Remove existing modal if any
            document.getElementById('custom-modal')?.remove();

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <p class="text-lg font-medium mb-4 text-gray-800">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">Cancel</button>
                            <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('custom-modal');
            const confirmButton = document.getElementById('modal-confirm');
            const cancelButton = document.getElementById('modal-cancel');

            const closeModal = () => modal.remove();

            confirmButton.onclick = () => {
                onConfirm();
                closeModal();
            };

            cancelButton.onclick = closeModal;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
        }


        // --- 3. CHATBOT LOGIC (Sprinkles) ---
        
        const knowledgeBase = `# K's Kupcakes Knowledge Base (The Sugar Sprinkle Spot)

## 1. Business Identity and Location (MUST BE ACCURATE)
* Q: What is the official name of the shop? A: The Sugar Sprinkle Spot.
* Q: What is the physical address/location? A: We are a home-based business and do not have a public storefront. All orders are for local meetup/pickup or delivery only.
* Q: What is the best phone number to call? A: (407) 799-0341.
* Q: What are your hours of operation? A: Inquiries are accepted 24/7 via social media or voicemail. Fulfillment (delivery and local pickup scheduling) is generally handled during these windows: Monday-Friday, 5:00 PM - 9:00 PM, and Saturday 10:00 AM - 2:00 PM.
* Q: Do you have a website? A: No, we operate solely through social media platforms (please search for "The Sugar Sprinkle Spot").

## 2. Menu and Product Details
* Q: What are your four most popular cupcake flavors and their price? A: We are a made-to-order bakery! We do not keep standard stock flavors. The customer chooses their preferred flavor, filling, and frosting. Please tell me what flavor you are interested in!
* Q: What is the price of a standard dozen cupcakes? A: Our bulk order pricing is:
    * 1 Dozen: $30
    * 2 Dozen: $35
    * 3 Dozen: $40
    * 4 Dozen: $45
* Q: Do you offer custom cakes? A: Yes! We specialize in custom cakes. All custom cake inquiries require 48 hours notice. Please ask me to start a custom order request!
* Q: Do you offer seasonal flavors? A: Yes, our current seasonal flavor is Pumpkin.

## 3. Policy and Logistics
* Q: What is your policy on allergies and cross-contamination? A: We do offer Gluten-Free options. HOWEVER, as we are a home kitchen, there is a possibility of cross-contamination with common allergens, including nuts and gluten. We cannot guarantee a certified allergen-free product.
* Q: What is your minimum required deposit? A: A deposit of 1/2 down (50%) is required at the time of booking for all orders.
* Q: What is the rush order fee? A: There is a minimum $25 fee for rush orders.
* Q: Do you offer delivery? A: Yes, we offer delivery up to a 100-mile max radius.
* Q: What is the delivery fee? A: The delivery fee is determined dynamically based on location. For local (in-town) meetups, delivery is often complimentary. For distances requiring travel, the fee will be calculated upon checkout.
* Q: How far in advance do I need to place a large order (2+ dozen)? A: We require 48 hours notice for large orders.
* Q: Do you accept corporate orders or catering? A: Yes! For large events or catering, please ask me to start a custom order request so we can provide a personalized quote.`;

        const systemPrompt = `
You are 'Sprinkles', the virtual baker and assistant for The Sugar Sprinkle Spot, a made-to-order, home-based bakery.
Your primary directive is to answer customer questions using ONLY the provided knowledge base (KB).
If a question cannot be answered with the KB, politely state that you do not have that information and provide the shop's phone number ((407) 799-0341) for human assistance.

Persona Rules:
1. Tone: Cheerful, friendly, and professional. Use light baking metaphors (e.g., "Let's whip up an answer," "That's the icing on the cake!").
2. Focus: Emphasize that the bakery is made-to-order (customers choose the flavor) and home-based (no public storefront).
3. Lead Qualification: If the user explicitly asks to "start a custom order," "place a large order," or "ask about a cake," immediately trigger the "CUSTOM_ORDER_FLOW" by starting the conversation with Step 1 of the Lead Qualification Script. Do not answer other questions until the flow is complete or canceled.

Lead Qualification Script (CUSTOM_ORDER_FLOW):
Step 1: "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?"
Step 2 (After Step 1 is answered): "Thank you! I see you need [RECAP DETAILS]. I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book!)"
Step 3 (After Step 2 is answered): "Perfect! I have captured all the delicious details: [FULL RECAP OF ORDER]. Our baker will review these details and contact you at [PHONE NUMBER] within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?"
`;
        let isInOrderFlow = false;
        let orderStep = 0;
        let customOrderDetails = {};

        /**
         * Handles the logic for the custom order qualification flow.
         */
        function handleCustomOrderFlow(userMessage) {
            // If the user tries to exit the flow
            if (userMessage.toLowerCase().includes('cancel') || userMessage.toLowerCase().includes('stop')) {
                isInOrderFlow = false;
                orderStep = 0;
                customOrderDetails = {};
                return "Order flow canceled. Feel free to ask any other questions about The Sugar Sprinkle Spot!";
            }

            if (orderStep === 1) {
                // Collect Date, Time, Type, Name, Phone Number (Step 1)
                customOrderDetails.step1 = userMessage;
                orderStep = 2;
                
                // Try to extract some details for the recap
                const typeMatch = userMessage.match(/(\d+\s+dozen|\bcake\b|\bcatering\b)/i) || ['order'];

                return `Thank you! I see you need a ${typeMatch[0]}. I just need two more details: 4) What is the desired **Flavor/Theme/Allergies**? 5) Where is the **Delivery Address** so we can calculate the fee? (Remember, a 50% deposit is required to book!)`;
                
            } else if (orderStep === 2) {
                // Collect Flavor/Theme/Allergies and Delivery Address (Step 2)
                customOrderDetails.step2 = userMessage;
                orderStep = 3;
                
                // Move to recap and save the lead
                const nameMatch = customOrderDetails.step1.match(/name\s*:\s*([a-z\s]+)/i) || customOrderDetails.step1.match(/(?:my name is|i'm)\s*([a-z\s]+)/i) || ['Customer'];
                const phoneNum = customOrderDetails.step1.match(/\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/) || ['(407) 799-0341 (No number provided)'];
                
                const leadDetails = {
                    OrderType: customOrderDetails.step1.substring(0, 50),
                    Date: customOrderDetails.step1.substring(0, 50),
                    Details: customOrderDetails.step2,
                    ContactInfo: `${nameMatch[0]} / ${phoneNum[0]}`,
                    DeliveryAddress: customOrderDetails.step2.substring(0, 50) 
                };

                saveChatLead(leadDetails); // Save the lead to Firestore

                isInOrderFlow = false;
                orderStep = 0;
                return `Perfect! I have captured all the delicious details. Our baker will review these details and contact you at ${phoneNum[0]} within 24 hours to confirm the final quote and collect the deposit. Is there anything else I can help you with today?`;
            }

            // Initialize flow if not started
            orderStep = 1;
            isInOrderFlow = true;
            return "I'd be happy to start that for you! To give our baker the best details, I need three main ingredients: 1) What is the **Date** and **Time** you need the order? 2) What is the **Type of item** (e.g., 2 dozen cupcakes, a custom birthday cake, catering)? 3) What is the best **Name and Phone Number** for our baker to call you back?";
        }

        /**
         * Saves a completed chat lead to Firestore.
         */
        async function saveChatLead(details) {
            if (!currentUserId) {
                console.error("Cannot save lead: Admin user ID is not set.");
                return;
            }
            try {
                const ordersCollectionPath = `artifacts/${appId}/users/${currentUserId}/orders`;
                await addDoc(collection(db, ordersCollectionPath), {
                    // Use a generic name for dashboard list
                    item: "Chat Lead", 
                    quantity: 1, 
                    status: "Pending",
                    details: details, // Store the structured conversation data
                    source: "Chatbot",
                    createdAt: serverTimestamp()
                });
                console.log("Chat lead successfully saved to Firestore.");
            } catch (error) {
                console.error("Error adding chat lead document: ", error);
            }
        }


        // --- 4. GEMINI API INTERACTION ---

        const chatHistory = []; // Only for standard chat, not flow
        
        async function getGeminiResponse(userQuery) {
            if (!userQuery) return "I need a message to get started! Ask me about flavors, delivery, or custom orders.";

            // 1. Check/Handle Order Flow
            if (isInOrderFlow || userQuery.toLowerCase().includes('custom order') || userQuery.toLowerCase().includes('place order') || userQuery.toLowerCase().includes('start order')) {
                return handleCustomOrderFlow(userQuery);
            }
            
            // 2. Standard Chat (FAQ Mode)
            
            // Include the Knowledge Base content directly in the prompt for grounding
            const fullQuery = `
                KNOWLEDGE BASE:\n---\n${knowledgeBase}\n---\n
                USER QUERY: ${userQuery}
            `;

            const payload = {
                contents: [{ role: "user", parts: [{ text: fullQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            let retries = 0;
            const MAX_RETRIES = 5;

            while (retries < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        }
                    }
                } catch (error) {
                    console.error(`Attempt ${retries + 1} failed:`, error);
                }

                retries++;
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000; // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            return "Oops! I seem to have mixed up the ingredients. Please try your question again, or call our baker directly at (407) 799-0341!";
        }

        // --- 5. UI INTEGRATION ---
        
        function appendMessage(sender, text) {
            const chatbox = document.getElementById('chat-messages');
            if (!chatbox) return;

            const messageElement = document.createElement('div');
            messageElement.className = sender === 'user' ? 'user-message' : 'bot-message';
            messageElement.innerHTML = `
                <div class="p-3 rounded-xl shadow-md max-w-full sm:max-w-xs ${sender === 'user' ? 'bg-indigo-100 text-indigo-800 ml-auto' : 'bg-white text-gray-700 border border-gray-100'}">
                    ${text.replace(/\n/g, '<br>')}
                </div>
                <small class="text-xs text-gray-400 mt-1 block ${sender === 'user' ? 'text-right' : 'text-left'}">${sender === 'user' ? 'You' : 'Sprinkles'}</small>
            `;
            chatbox.appendChild(messageElement);
            chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to latest message
        }

        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const message = inputElement.value.trim();
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');

            if (message === '') return;

            inputElement.value = '';
            appendMessage('user', message);
            sendButton.disabled = true;

            // Show typing indicator
            typingIndicator.classList.remove('hidden');
            typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'end' });

            // Get the response
            const botResponse = await getGeminiResponse(message);

            // Hide typing indicator and display response
            typingIndicator.classList.add('hidden');
            appendMessage('bot', botResponse);
            sendButton.disabled = false;
        }

        // Attach event listeners when the window loads
        window.onload = () => {
            document.getElementById('send-button')?.addEventListener('click', sendMessage);
            document.getElementById('user-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Initial greeting for the Chatbot
            appendMessage('bot', `Hello! I'm Sprinkles, your virtual baker and assistant for The Sugar Sprinkle Spot. How can I help you whip up the perfect order today? (Try asking about delivery, pricing, or "start a custom order"!)`);
        };
    </script>
</body>
</html>
